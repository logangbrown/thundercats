angular.module("time").controller("ProjectCtrl",["$scope","$http","$routeParams","$location","usSpinnerService",function(n,t,i,r,u){n.loaded=!1;n.config={};n.config.showInactiveGroups=!1;n.load=function(){var f,e,o;n.projectID=i.ID;n.projectID||r.path("/courses");u.spin("spinner");t.post("/Home/GetProject",{projectID:n.projectID}).then(function(t){n.project={};n.project.projectID=t.data.projectID;n.project.projectName=t.data.projectName;n.project.isActive=t.data.isActive;n.project.description=t.data.description;n.project.courseID=t.data.courseID;n.project.groups={};$.each(t.data.groups,function(t,i){n.project.groups[i.groupID]={};n.project.groups[i.groupID].evalID=i.evalID;n.project.groups[i.groupID].groupID=i.groupID;n.project.groups[i.groupID].groupName=i.groupName;n.project.groups[i.groupID].isActive=i.isActive;n.project.groups[i.groupID].users={};$.each(i.users,function(t,r){n.project.groups[i.groupID].users[r.userID]={};n.project.groups[i.groupID].users[r.userID].firstName=r.firstName;n.project.groups[i.groupID].users[r.userID].lastName=r.lastName;n.project.groups[i.groupID].users[r.userID].isActive=r.isActive;n.project.groups[i.groupID].users[r.userID].userID=r.userID;n.project.groups[i.groupID].users[r.userID].timecards={};$.each(r.timecards,function(t,u){n.project.groups[i.groupID].users[r.userID].timecards[u.timeslotID]=u;n.project.groups[i.groupID].users[r.userID].timecards[u.timeslotID].hours=""})})});n.updateAllHours();n.updateChart();u.stop("spinner")},function(n){u.stop("spinner");n.status===401?toastr.error("Unauthorized to view this project."):toastr.error("Failed to load project, unknown error.")});n.createGroup=function(){t.post("/Home/CreateGroup",{projectID:n.projectID}).then(function(n){r.path("/group/"+n.data)},function(n){n.status===401?toastr.error("Unauthorized to create a group on this project."):n.status===403?toastr.error("You are already part of a group on this project. Please leave the group before creating a new one."):toastr.error("Failed to create group, unknown error.")})};n.saveProject=function(){t.post("/Home/SaveProject",{projectID:n.project.projectID,projectName:n.project.projectName,description:n.project.description,isActive:n.project.isActive}).then(function(){toastr.success("Saved group.")},function(){toastr.error("Failed to save group.")})};n.updateAllHours=function(){$.each(n.project.groups,function(t,i){$.each(i.users,function(t,r){$.each(r.timecards,function(t,u){u.timeIn!==""&&u.timeOut!==""&&(n.project.groups[i.groupID].users[r.userID].timecards[u.timeslotID].hours=moment.duration(moment(n.project.groups[i.groupID].users[r.userID].timecards[u.timeslotID].timeOut).diff(n.project.groups[i.groupID].users[r.userID].timecards[u.timeslotID].timeIn)).asHours().toFixed(2))})})})};f={datasets:[{data:[],backgroundColor:["#2C3E50","#3498DB","#18BC9C","#F39C12","#e83e8c","#6610f2","#fd7e14","#E74C3C","#6f42c1","#95a5a6","#2C3E50","#3498DB","#18BC9C","#F39C12","#e83e8c","#6610f2","#fd7e14","#E74C3C","#6f42c1","#95a5a6","#2C3E50","#3498DB","#18BC9C","#F39C12","#e83e8c","#6610f2","#fd7e14","#E74C3C","#6f42c1","#95a5a6",]}],labels:[]};n.setData=function(){var t,u,i,r;if(n.project&&n.project.groups){f.datasets[0].data=[];f.labels=[];for(t in n.project.groups)if(t=n.project.groups[t],t.isActive||n.config.showInactiveGroups){u=0;for(i in t.users){i=t.users[i];for(r in i.timecards)r=i.timecards[r],u+=Number(r.hours)}f.datasets[0].data.push(u);f.labels.push(t.groupName)}}};n.setData();e=$("#projectHours");o=new Chart(e,{type:"pie",data:f});n.updateChart=function(){n.setData();o.update()};n.loaded=!0};n.$parent.user&&n.$parent.user!==""?n.load():t.get("/Home/CheckSession").then(function(t){n.$parent.user=t.data;n.$parent.loaded=!0;n.load()},function(){toastr.error("Not logged in.");r.path("/login")})}]);