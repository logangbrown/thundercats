angular.module("time").controller("UserCtrl",["$scope","$http","$routeParams","$location","usSpinnerService",function(n,t,i,r,u){n.loaded=!1;n.userID=i.ID;n.viewUser={};n.viewUser.currentPassword="";n.viewUser.newPassword="";n.viewUser.repeatPassword="";n.userID||r.path("/users");n.load=function(){u.spin("spinner");t.post("/Home/GetUser",{userID:n.userID}).then(function(t){n.viewUser=t.data;u.stop("spinner");n.loaded=!0;t.status===204&&(toastr.error("Unauthorized to view user."),window.history.back())},function(){u.stop("spinner");toastr.error("Failed to get user.");r.path("/dashboard")});n.saveUser=function(){t.post("/Home/ChangeUser",n.viewUser).then(function(){toastr.success("User saved.")},function(n){n.status===500?toastr.error("Failed to save user, query error."):n.status===401?toastr.error("Unauthorized to make changes to this user."):n.status===403?toastr.error("Username already exists, choose a new username. No changes saved!"):n.status===400?toastr.error("Must enter a username. No changes saved!"):toastr.error("Failed to save user, unknown error.")})};n.changePassword=function(){if(n.viewUser.username){if(n.viewUser.newPassword===""){toastr.error("Please enter a Password");return}if(n.viewUser.repeatPassword!==n.viewUser.newPassword){toastr.error("Your passwords don't match.");return}}else{toastr.error("Please enter a Username");return}if(n.$parent.user.type!=="A"&&!n.viewUser.currentPassword){toastr.error("You must enter your current password.");return}var i={userID:n.viewUser.userID};i.password=CryptoJS.SHA256(n.viewUser.currentPassword).toString(CryptoJS.enc.Hex);i.newPassword=CryptoJS.SHA256(n.viewUser.newPassword).toString(CryptoJS.enc.Hex);t.post("/Home/ChangePassword",i).then(function(){toastr.success("Password changed.")},function(n){n.status===500?toastr.error("Password incorrect."):toastr.error("Failed to change password.")})}};n.$parent.user&&n.$parent.user!==""?n.$parent.user.type!=="A"&&n.$parent.user.userID!==Number(n.userID)?(toastr.error("Not Admin or the specified user."),r.path("/dashboard")):n.load():t.get("/Home/CheckSession").then(function(t){n.$parent.user=t.data;n.$parent.user.type!=="A"&&n.$parent.user.userID!==Number(n.userID)&&(toastr.error("Not Admin or the specified user."),r.path("/dashboard"));n.$parent.loaded=!0;n.load()},function(){toastr.error("Not logged in.");r.path("/login")})}]);