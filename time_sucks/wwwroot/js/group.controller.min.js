angular.module("time").controller("GroupCtrl",["$scope","$http","$routeParams","$location","usSpinnerService",function(n,t,i,r,u){n.loaded=!1;n.group={};n.group.users={};n.load=function(){var f,e,o;n.groupID=i.ID;n.groupID||r.path("/courses");u.spin("spinner");t.post("/Home/GetGroup",{groupID:n.groupID}).then(function(t){n.group={};n.group.evalID=t.data.evalID;n.group.groupID=t.data.groupID;n.group.groupName=t.data.groupName;n.group.isActive=t.data.isActive;n.group.projectID=t.data.projectID;n.group.users={};$.each(t.data.users,function(t,i){n.group.users[i.userID]={};n.group.users[i.userID].firstName=i.firstName;n.group.users[i.userID].lastName=i.lastName;n.group.users[i.userID].isActive=i.isActive;n.group.users[i.userID].userID=i.userID;n.group.users[i.userID].timecards={};$.each(i.timecards,function(t,r){n.group.users[i.userID].timecards[r.timeslotID]=r;n.group.users[i.userID].timecards[r.timeslotID].hours=""})});n.updateAllHours();n.updateChart();u.stop("spinner")},function(){u.stop("spinner");toastr.error("Failed to get group.")});$.each(n.group.users,function(t){n.group.users[t].blank={timeslotID:t+"-blank",hours:"",isEdited:!1,timeIn:"",timeOut:"",description:""}});n.createTime=function(t,i=""){var r={userID:t,groupID:n.groupID};n.group.users[t].timecards[n.newNumber]={timeslotID:n.newNumber,hours:"",isEdited:!1,timeIn:i,timeOut:"",description:""};n.newNumber++;toastr.info("Create time for user: "+t)};n.createTimeFromBlank=function(t){var i={userID:t,groupID:n.groupID};(n.group.users[t].blank.timeIn!==""||n.group.users[t].blank.timeOut!==""||n.group.users[t].blank.desc!=="")&&(n.group.users[t].timecards[n.newNumber]={timeslotID:n.newNumber,hours:"",isEdited:!1,timeIn:n.group.users[t].blank.timeIn,timeOut:n.group.users[t].blank.timeOut,description:n.group.users[t].blank.desc},n.newNumber++,n.group.users[t].blank.timeIn="",n.group.users[t].blank.timeOut="",n.group.users[t].blank.desc="",toastr.info("Create time for user: "+t))};n.leaveGroup=function(){confirm("Are you sure you want to leave this group?")&&(n.group.users[n.$parent.user.userID].isActive=!1,toastr.info("Attempted to leave group - enable REST endpoint."))};n.joinGroup=function(){n.group.users[n.$parent.user.userID]={userID:n.$parent.user.userID,firstName:n.$parent.user.firstName,lastName:n.$parent.user.lastName,isActive:!0,timecards:{}};toastr.info("Attempted to leave group - enable REST endpoint.")};n.saveGroup=function(){toastr.info("Attempted to save group - enable REST endpoint");n.updateChart()};n.userInGroup=function(){if(!n.$parent.user)return!1;var t=!1;return n.group?($.each(n.group.users,function(i,r){Number(r.userID)===Number(n.$parent.user.userID)&&(t=!0)}),t):!1};n.hasUnfinishedBusiness=function(){var t=!1;return n.userInGroup()&&$.each(n.group.users[n.$parent.user.userID].timecards,function(n,i){i.timeIn!==""&&i.timeOut===""&&(t=!0)}),t};n.startTime=function(){n.userInGroup()?n.createTime(n.$parent.user.userID,moment().format("MM/DD/YYYY h:mm A")):toastr.error("The logged in user isn't a member of the group.")};n.endTime=function(){n.userInGroup()?$.each(n.group.users[n.$parent.user.userID].timecards,function(t,i){if(i.timeIn!==""&&i.timeOut==="")return n.group.users[n.$parent.user.userID].timecards[i.timeslotID].timeOut=moment().format("MM/DD/YYYY h:mm A"),n.group.users[n.$parent.user.userID].timecards[i.timeslotID].hours=moment.duration(moment(n.group.users[n.$parent.user.userID].timecards[i.timeslotID].timeOut).diff(n.group.users[n.$parent.user.userID].timecards[i.timeslotID].timeIn)).asHours().toFixed(2),!1}):toastr.error("The logged in user isn't a member of the group.")};n.saveTime=function(t,i){n.group.users[t].timecards[i].hours=n.group.users[t].timecards[i].timeIn===""||n.group.users[t].timecards[i].timeOut===""?0:moment.duration(moment(n.group.users[t].timecards[i].timeOut).diff(n.group.users[t].timecards[i].timeIn)).asHours().toFixed(2);n.updateChart()};n.diffHours=function(n,t){return n===""||t===""?"0.00":moment.duration(moment(t).diff(n)).asHours().toFixed(2)};n.formatTime=function(){};n.isUser=function(t){return n.$parent.user?t===n.$parent.user.userID||n.$parent.user.type==="A":!1};n.updateAllHours=function(){$.each(n.group.users,function(t,i){$.each(i.timecards,function(t,r){r.timeIn!==""&&r.timeOut!==""&&(n.group.users[i.userID].timecards[r.timeslotID].hours=moment.duration(moment(n.group.users[i.userID].timecards[r.timeslotID].timeOut).diff(n.group.users[i.userID].timecards[r.timeslotID].timeIn)).asHours().toFixed(2))})})};f={datasets:[{data:[],backgroundColor:["#2C3E50","#3498DB","#18BC9C","#F39C12","#e83e8c","#6610f2","#fd7e14","#E74C3C","#6f42c1","#95a5a6","#2C3E50","#3498DB","#18BC9C","#F39C12","#e83e8c","#6610f2","#fd7e14","#E74C3C","#6f42c1","#95a5a6","#2C3E50","#3498DB","#18BC9C","#F39C12","#e83e8c","#6610f2","#fd7e14","#E74C3C","#6f42c1","#95a5a6"]}],labels:[]};n.setData=function(){var t,r,i;f.datasets[0].data=[];f.labels=[];for(t in n.group.users){t=n.group.users[t];r=0;for(i in t.timecards)i=t.timecards[i],r+=Number(i.hours);f.datasets[0].data.push(r);f.labels.push(t.firstName+" "+t.lastName)}};n.setData();e=$("#groupHours");o=new Chart(e,{type:"pie",data:f});n.updateChart=function(){n.setData();o.update()};n.updateAllHours();n.updateChart();n.loaded=!0};n.$parent.user&&n.$parent.user!==""?n.load():t.get("/Home/CheckSession").then(function(t){n.$parent.user=t.data;n.$parent.loaded=!0;n.load()},function(){toastr.error("Not logged in.");r.path("/login")})}]);