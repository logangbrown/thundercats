angular.module("time").controller("GroupCtrl",["$scope","$http","$routeParams","$location","usSpinnerService",function(n,t,i,r,u){n.loaded=!1;n.group={};n.group.users={};n.load=function(){var f,e,o;n.groupID=i.ID;n.groupID||r.path("/courses");u.spin("spinner");t.post("/Home/GetGroup",{groupID:n.groupID}).then(function(t){n.group={};n.group.evalID=t.data.evalID;n.group.groupID=t.data.groupID;n.group.groupName=t.data.groupName;n.group.isActive=t.data.isActive;n.group.projectID=t.data.projectID;n.group.users={};$.each(t.data.users,function(t,i){n.group.users[i.userID]={};n.group.users[i.userID].firstName=i.firstName;n.group.users[i.userID].lastName=i.lastName;n.group.users[i.userID].isActive=i.isActive;n.group.users[i.userID].userID=i.userID;n.group.users[i.userID].timecards={};$.each(i.timecards,function(t,r){n.group.users[i.userID].timecards[r.timeslotID]=r;n.group.users[i.userID].timecards[r.timeslotID].hours=""})});n.updateAllHours();n.updateChart();u.stop("spinner")},function(n){u.stop("spinner");n.status===401?(toastr.error("Unauthorized to view this group."),window.history.back()):toastr.error("Error getting group.")});$.each(n.group.users,function(t){n.group.users[t].blank={timeslotID:t+"-blank",hours:"",isEdited:!1,timeIn:"",timeOut:"",description:""}});n.createTime=function(i,r=""){var u={userID:i,groupID:n.groupID,timeIn:r,isEdited:!1,timeOut:"",description:""};t.post("/Home/CreateTimeCard",u).then(function(t){n.group.users[i].timecards[t.data]={timeslotID:t.data,hours:"",isEdited:!1,timeIn:r,timeOut:"",description:"",userID:i};toastr.success("Timeslot created.")},function(){toastr.error("Failed to create time.")})};n.createTimeFromBlank=function(i){var r={userID:i,groupID:n.groupID,timeIn:n.group.users[i].blank.timeIn,timeOut:n.group.users[i].blank.timeOut,description:n.group.users[i].blank.description,isEdited:!1};(n.group.users[i].blank.timeIn!==""||n.group.users[i].blank.timeOut!==""||n.group.users[i].blank.description!=="")&&(u.spin("spinner"),t.post("/Home/CreateTimeCard",r).then(function(t){u.stop("spinner");n.group.users[i].timecards[t.data]={userID:i,timeslotID:t.data,hours:"",isEdited:!1,timeIn:n.group.users[i].blank.timeIn,timeOut:n.group.users[i].blank.timeOut,description:n.group.users[i].blank.description};n.group.users[i].blank.timeIn="";n.group.users[i].blank.timeOut="";n.group.users[i].blank.description="";toastr.success("Timeslot created.")},function(){u.stop("spinner");toastr.error("Failed to create time.")}))};n.leaveGroup=function(){confirm("Are you sure you want to leave this group?")&&(u.spin("spinner"),t.post("/Home/LeaveGroup",{groupID:n.groupID}).then(function(t){t.status===204?delete n.group.users[n.$parent.user.userID]:n.group.users[n.$parent.user.userID].isActive=!1;u.stop("spinner");toastr.success("You left the group.")},function(n){u.stop("spinner");n.status===401?toastr.error("You are not part of this group."):toastr.error("Failed to leave the group, unknown error.")}))};n.joinGroup=function(){u.spin("spinner");t.post("/Home/JoinGroup",{groupID:n.groupID}).then(function(t){t.status===204?n.group.users[n.$parent.user.userID].isActive=!0:n.group.users[n.$parent.user.userID]={userID:n.$parent.user.userID,firstName:n.$parent.user.firstName,lastName:n.$parent.user.lastName,isActive:!0,timecards:{}};u.stop("spinner");toastr.success("You have joined the group.")},function(n){u.stop("spinner");n.status===401?toastr.error("You are not part of this course."):n.status===403?toastr.error("You are already active in a different group. Please leave that group before joining a new one."):toastr.error("Failed to join the group, unknown error.")})};n.saveGroup=function(){t.post("/Home/SaveGroup",{groupID:n.group.groupID,groupName:n.group.groupName,isActive:n.group.isActive,evalID:n.group.evalID,projectID:n.group.projectID}).then(function(){toastr.success("Group saved.")},function(n){n.status===401?toastr.error("Unauthorized to change this group."):toastr.error("Failed to save group, unknown error.")})};n.userInGroup=function(){if(!n.$parent.user)return!1;var t=!1;return n.group?($.each(n.group.users,function(i,r){Number(r.userID)===Number(n.$parent.user.userID)&&(t=!0)}),t):!1};n.userActiveInGroup=function(){if(!n.$parent.user)return!1;var t=!1;return n.group?($.each(n.group.users,function(i,r){Number(r.userID)===Number(n.$parent.user.userID)&&r.isActive&&(t=!0)}),t):!1};n.hasUnfinishedBusiness=function(){var t=!1;return n.userInGroup()&&$.each(n.group.users[n.$parent.user.userID].timecards,function(n,i){i.timeIn!==""&&i.timeOut===""&&(t=!0)}),t};n.startTime=function(){n.userInGroup()?n.createTime(n.$parent.user.userID,moment().format("MM/DD/YYYY h:mm A")):toastr.error("The logged in user isn't a member of the group.")};n.endTime=function(){n.userInGroup()?$.each(n.group.users[n.$parent.user.userID].timecards,function(t,i){if(i.timeIn!==""&&i.timeOut==="")return n.group.users[n.$parent.user.userID].timecards[i.timeslotID].timeOut=moment().format("MM/DD/YYYY h:mm A"),n.group.users[n.$parent.user.userID].timecards[i.timeslotID].hours=moment.duration(moment(n.group.users[n.$parent.user.userID].timecards[i.timeslotID].timeOut).diff(n.group.users[n.$parent.user.userID].timecards[i.timeslotID].timeIn)).asHours().toFixed(2),!1}):toastr.error("The logged in user isn't a member of the group.")};n.saveTime=function(i,r){t.post("/Home/SaveTime",n.group.users[i].timecards[r]).then(function(){n.group.users[i].timecards[r].hours=n.group.users[i].timecards[r].timeIn===""||n.group.users[i].timecards[r].timeOut===""?0:moment.duration(moment(n.group.users[i].timecards[r].timeOut).diff(n.group.users[i].timecards[r].timeIn)).asHours().toFixed(2);n.updateChart();toastr.success("Timeslot saved.")},function(n){n.status===401?toastr.error("Unauthorized to edit this time entry."):toastr.error("Failed to save time entry, unknown error.")})};n.diffHours=function(n,t){return n===""||t===""?"0.00":moment.duration(moment(t).diff(n)).asHours().toFixed(2)};n.isUser=function(t){return n.$parent.user?t===n.$parent.user.userID||n.$parent.user.type==="A":!1};n.updateAllHours=function(){$.each(n.group.users,function(t,i){$.each(i.timecards,function(t,r){r.timeIn!==""&&r.timeOut!==""&&(n.group.users[i.userID].timecards[r.timeslotID].hours=moment.duration(moment(n.group.users[i.userID].timecards[r.timeslotID].timeOut).diff(n.group.users[i.userID].timecards[r.timeslotID].timeIn)).asHours().toFixed(2))})})};f={datasets:[{data:[],backgroundColor:["#2C3E50","#3498DB","#18BC9C","#F39C12","#e83e8c","#6610f2","#fd7e14","#E74C3C","#6f42c1","#95a5a6","#2C3E50","#3498DB","#18BC9C","#F39C12","#e83e8c","#6610f2","#fd7e14","#E74C3C","#6f42c1","#95a5a6","#2C3E50","#3498DB","#18BC9C","#F39C12","#e83e8c","#6610f2","#fd7e14","#E74C3C","#6f42c1","#95a5a6"]}],labels:[]};n.setData=function(){var t,r,i;f.datasets[0].data=[];f.labels=[];for(t in n.group.users){t=n.group.users[t];r=0;for(i in t.timecards)i=t.timecards[i],r+=Number(i.hours);f.datasets[0].data.push(r);f.labels.push(t.firstName+" "+t.lastName)}};n.setData();e=$("#groupHours");o=new Chart(e,{type:"pie",data:f});n.updateChart=function(){n.setData();o.update()};n.updateAllHours();n.updateChart();n.loaded=!0};u.spin("spinner");t.get("/Home/CheckSession").then(function(t){u.stop("spinner");n.$parent.user=t.data;n.$parent.loaded=!0;n.load()},function(){u.stop("spinner");toastr.error("Not logged in.");r.path("/login")})}]);